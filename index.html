<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" href="favicon/favicon.ico">
    <title>CubeScape</title>
    <!-- CSS do Ranking -->
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
  <canvas class="threejs-canvas"></canvas>
  <canvas class="pixi-canvas"></canvas>
  <div id="container"></div>
  <div class="loading-percent"></div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Inicializar Supabase
    window.supabase = supabase.createClient(
      'https://ctoffxmespqcgsdfxxll.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0b2ZmeG1lc3BxY2dzZGZ4eGxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNTc1OTIsImV4cCI6MjA2ODgzMzU5Mn0.OMNHUHAociZqrhbY6HtkeWk_BwGaPn2uaRFWDZh-Yx4'
    );

    // Cross-domain auth via querystring
    const urlParams = new URLSearchParams(window.location.search);
    const authToken = urlParams.get('auth_token');
    const userIdParam = urlParams.get('user_id');
    const userEmail = urlParams.get('user_email');
    const userName = urlParams.get('user_name');
    const userType = urlParams.get('user_type');

    if (authToken && userIdParam && userEmail && userName && userType) {
      console.log('üîë Token de autentica√ß√£o encontrado na URL, configurando sess√£o...');
      window.supabase.auth.setSession({
        access_token: authToken,
        refresh_token: authToken
      }).then(({ data, error }) => {
        if (error) {
          console.error('‚ùå Erro ao configurar sess√£o:', error);
        } else {
          console.log('‚úÖ Sess√£o configurada com sucesso para cross-domain auth');
          console.log('üë§ Usu√°rio:', userName, '(', userEmail, ')');
        }
      });
    } else {
      console.log('‚ÑπÔ∏è Nenhum token de autentica√ß√£o encontrado na URL');
      window.supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
          console.log('‚úÖ Sess√£o encontrada');
        } else {
          console.log('‚ÑπÔ∏è Nenhuma sess√£o encontrada, usu√°rio pode ser an√¥nimo');
        }
      });
    }
  </script>

  <!-- API de pontua√ß√µes -->
  <script src="../game-api.js"></script>
  <!-- Ranking Modal -->
  <script src="../ranking.js"></script>
  <script>
    // Inicializar API de pontua√ß√£o quando houver sess√£o
    (function initScoreAPI() {
      if (!window.supabase || !window.initGameScoreAPI) return;
      window.supabase.auth.getSession().then(({ data: { session }, error }) => {
        if (error) {
          console.error('‚ùå Erro ao obter sess√£o:', error);
          return;
        }
        if (session && session.user) {
          console.log('üöÄ Inicializando API de pontua√ß√µes para:', session.user.id);
          window.initGameScoreAPI(session.user.id);
        } else {
          console.log('‚ÑπÔ∏è Usu√°rio n√£o logado - API de pontua√ß√£o n√£o inicializada');
        }
      });
    })();
  </script>

  <script type="module" src="./src/main.ts"></script>
</body>
</html>
